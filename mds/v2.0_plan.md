# AI Advisor Feature Plan (v2.0)

## Context
The `/ai-advisor` route is currently a `PlaceholderPage`. This plan implements it as a full-page streaming chatbot powered by OpenAI (`gpt-4o-mini`, key already in `.env`). The AI is scoped to Marquette academic advising topics only. No student context is injected at this stage — that is deferred until the Saved Plans tab is built (future work).

---

## Decisions
| Question | Decision |
|---|---|
| Context injection | None for now — fresh general advisor. Note for future: inject from saved plan. |
| Chat persistence | Session-only (React state). Clears on reload/navigation. |
| Layout | Full-page chat (message list + sticky input bar) |
| Streaming | Yes — SSE from Flask, `ReadableStream` on frontend |
| Starter prompts | 3–4 clickable chips, hidden once chat starts |
| Scope guardrails | Academic topics only via system prompt |
| Error UX | Inline error bubble with retry button |

---

## Files to Modify / Create

| File | Action |
|---|---|
| `requirements.txt` | Add `openai>=1.0.0` |
| `backend/server.py` | Add `POST /api/ai-advisor` streaming endpoint |
| `frontend-next/next.config.js` | Add `/api/ai-advisor` rewrite for dev proxy |
| `frontend-next/src/lib/types.ts` | Add `ChatMessage` type |
| `frontend-next/src/lib/api.ts` | Add `streamAiAdvisor()` function |
| `frontend-next/src/hooks/useAiAdvisor.ts` | **New** — chat state + streaming logic |
| `frontend-next/src/app/ai-advisor/page.tsx` | Replace placeholder with chat UI |

---

## Step-by-Step Plan

### Step 1 — Backend: `requirements.txt`
Add one line:
```
openai>=1.0.0
```

---

### Step 2 — Backend: `POST /api/ai-advisor` (server.py)

Register the route alongside existing routes at the bottom of `server.py`.

**Request body:**
```json
{ "messages": [{ "role": "user", "content": "..." }] }
```

**Implementation:**
```python
from openai import OpenAI
import json

SYSTEM_PROMPT = """You are an academic advisor at Marquette University College of Business.
Help students understand degree requirements, course prerequisites, schedule planning,
and academic policies for the following majors: Finance, Accounting, Applied Investment
Management (AIM), Information Systems (IS), Business Analytics (BUAN),
Operations & Supply Chain Management (OSCM), and Human Resources (HURE).

Rules:
- Stay focused on Marquette academic advising topics only.
- If asked about unrelated topics, politely redirect back to academic advising.
- Be concise, friendly, and student-focused.
- Use standard course code format: "FINA 4075", "BUAD 1001", etc.
- Do not make up course information you are not certain about."""

@app.route("/api/ai-advisor", methods=["POST"])
def ai_advisor():
    ip = request.headers.get("X-Forwarded-For", request.remote_addr)
    if not app.config.get("TESTING") and not _check_rate_limit(ip):
        return jsonify({
            "mode": "error",
            "error": {"error_code": "RATE_LIMITED", "message": "Too many requests."}
        }), 429

    body = request.get_json(force=True, silent=True) or {}
    messages = body.get("messages", [])

    if not isinstance(messages, list) or not messages:
        return jsonify({
            "mode": "error",
            "error": {"error_code": "INVALID_INPUT", "message": "messages array required."}
        }), 400

    # Sanitize: only allow role/content keys, max 40 messages
    clean = [
        {"role": str(m.get("role", "user")), "content": str(m.get("content", ""))}
        for m in messages[-40:]
        if m.get("role") in ("user", "assistant") and m.get("content")
    ]

    api_key = os.environ.get("OPENAI_API_KEY", "")
    model = os.environ.get("OPENAI_MODEL", "gpt-4o-mini")

    if not api_key:
        return jsonify({
            "mode": "error",
            "error": {"error_code": "SERVER_ERROR", "message": "AI service not configured."}
        }), 500

    def generate():
        client = OpenAI(api_key=api_key)
        stream = client.chat.completions.create(
            model=model,
            messages=[{"role": "system", "content": SYSTEM_PROMPT}] + clean,
            stream=True,
            max_tokens=800,
        )
        for chunk in stream:
            delta = chunk.choices[0].delta.content
            if delta:
                yield f"data: {json.dumps({'delta': delta})}\n\n"
        yield "data: [DONE]\n\n"

    return Response(
        stream_with_context(generate()),
        mimetype="text/event-stream",
        headers={"Cache-Control": "no-cache", "X-Accel-Buffering": "no"},
    )
```

**Imports already in server.py:** `os`, `json`, `Response`, `stream_with_context` — confirm `stream_with_context` is imported from flask; add if missing.

---

### Step 3 — Frontend: `next.config.js`
Add to the `rewrites` array (inside the dev-only block):
```js
{ source: "/api/ai-advisor", destination: "http://localhost:5000/api/ai-advisor" }
```

---

### Step 4 — Frontend: `types.ts`
Add:
```typescript
export interface ChatMessage {
  id: string;
  role: "user" | "assistant";
  content: string;
  error?: boolean;
}
```

---

### Step 5 — Frontend: `api.ts`
Add a streaming fetch function:
```typescript
export async function streamAiAdvisor(
  messages: { role: "user" | "assistant"; content: string }[]
): Promise<Response> {
  const res = await fetch(`${API_BASE}/api/ai-advisor`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ messages }),
  });
  if (!res.ok) {
    const body = await res.json().catch(() => null);
    throw new Error(body?.error?.message || `AI Advisor request failed: ${res.status}`);
  }
  return res; // caller reads the stream
}
```

---

### Step 6 — Frontend: `useAiAdvisor.ts` (new hook)

```typescript
// frontend-next/src/hooks/useAiAdvisor.ts
"use client";

import { useState, useRef, useCallback } from "react";
import type { ChatMessage } from "@/lib/types";
import { streamAiAdvisor } from "@/lib/api";

export const STARTER_PROMPTS = [
  "What courses should I take next semester?",
  "Explain my remaining degree requirements.",
  "Can I take two majors at the same time?",
  "What are the prerequisites for upper-division Finance courses?",
];

export function useAiAdvisor() {
  const [messages, setMessages] = useState<ChatMessage[]>([]);
  const [streaming, setStreaming] = useState(false);
  const abortRef = useRef<AbortController | null>(null);

  const send = useCallback(async (content: string) => {
    const userMsg: ChatMessage = { id: crypto.randomUUID(), role: "user", content };
    const assistantId = crypto.randomUUID();
    const assistantMsg: ChatMessage = { id: assistantId, role: "assistant", content: "" };

    setMessages((prev) => [...prev, userMsg, assistantMsg]);
    setStreaming(true);

    const history = [...messages, userMsg].map(({ role, content }) => ({ role, content }));

    try {
      const res = await streamAiAdvisor(history);
      const reader = res.body!.getReader();
      const decoder = new TextDecoder();
      let buffer = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split("\n");
        buffer = lines.pop() ?? "";

        for (const line of lines) {
          if (!line.startsWith("data: ")) continue;
          const data = line.slice(6).trim();
          if (data === "[DONE]") break;
          try {
            const { delta } = JSON.parse(data);
            if (delta) {
              setMessages((prev) =>
                prev.map((m) =>
                  m.id === assistantId ? { ...m, content: m.content + delta } : m
                )
              );
            }
          } catch {}
        }
      }
    } catch (err) {
      const msg = err instanceof Error ? err.message : "Something went wrong.";
      setMessages((prev) =>
        prev.map((m) =>
          m.id === assistantId
            ? { ...m, content: msg, error: true }
            : m
        )
      );
    } finally {
      setStreaming(false);
    }
  }, [messages]);

  const retry = useCallback((failedContent: string) => {
    setMessages((prev) => prev.slice(0, -2)); // remove last user+assistant pair
    send(failedContent);
  }, [send]);

  const clear = useCallback(() => setMessages([]), []);

  return { messages, streaming, send, retry, clear };
}
```

---

### Step 7 — Frontend: `ai-advisor/page.tsx` (replace placeholder)

Full-page chat layout:
- **Empty state**: Gold greeting header + 4 starter prompt chips
- **Message list**: Scrollable, auto-scrolls to bottom on new message
- **User bubble**: Right-aligned, `bg-navy` background
- **Assistant bubble**: Left-aligned, `bg-surface-card` with bot avatar icon
- **Error bubble**: `bg-bad-light text-bad` with retry button
- **Streaming indicator**: Blinking cursor `▌` appended to last assistant message while streaming
- **Input bar**: Sticky at bottom — `<textarea>` (expands up to 4 rows) + gold send button; disabled while streaming
- **Send on Enter**: `Shift+Enter` for newline, `Enter` to send

Key classes to reuse from existing codebase:
- Container: `h-[calc(100vh-4rem)] flex flex-col`
- Cards: `bg-surface-card rounded-2xl border border-border-subtle`
- Input: `bg-surface-input border border-border-medium rounded-xl`
- Button: use existing `<Button variant="gold" size="sm">`
- Chips: use existing `<Chip>` component or inline gold pill styling
- Streaming cursor inline in assistant bubble

---

## System Prompt (Final)

```
You are an academic advisor at Marquette University College of Business.
Help students understand degree requirements, course prerequisites, schedule
planning, and academic policies for these majors: Finance, Accounting,
Applied Investment Management (AIM), Information Systems (IS), Business
Analytics (BUAN), Operations & Supply Chain Management (OSCM), and Human
Resources (HURE).

Rules:
- Stay focused on Marquette academic advising topics only.
- If asked about unrelated topics, politely redirect to academic advising.
- Be concise, friendly, and student-focused.
- Use standard course code format: "FINA 4075", "BUAD 1001", etc.
- Do not fabricate course details you are not certain about.
```

---

## Future Work (noted, not implemented)
- Inject student context (completed courses, majors, recommendations) once Saved Plans tab is built — pass as additional system context block.
- Add `ANTHROPIC_API_KEY` + `anthropic` SDK when switching to Claude.

---

## Verification
1. `pip install openai` + `python -m pytest tests/backend_tests -q` — all pass
2. `cd frontend-next && npm run build` — no type errors
3. `npm run lint` — 0 warnings
4. Manual: start server, open `/ai-advisor`, send "What is AIM?" → response streams in
5. Manual: send off-topic question → AI politely redirects
6. Manual: send message while streaming → send button is disabled
7. Manual: trigger API error (disconnect server) → inline error bubble appears with retry
